<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<!--
An element that provides a speed chart for Hero System games with basic combat order management tools.

Example:

    <speed-chart id="spdChart">
    </speed-chart>

@demo
-->
<dom-module id="speed-chart">

    <style>
        :host {
        @apply(--layout-vertical);
        }

        .container {
            display: flex;
            flex-direction: column;
            padding: 5px;
        }

        .combatant-row {
            @apply(--layout-horizontal)
            display: flex;
            flex-flow: row nowrap;
        }

        .combatant-row div.name {
            flex-grow: 4;
        }

        td {
            margin: 1px;
            text-align: center;
        }

        .cell {
            padding: 2px;
        }

        .current {
            background-color: #f48fb1;
        }

        .header td {
            border: 1px solid;
        }

    </style>

    <template>
        <paper-material elevation="2">
            <div class="container">
                <div class="row">
                    <table>

                        <tr class="header">
                            <td rowspan="2">Segment</td>
                            <td colspan="12">Speed</td>
                        </tr>
                        <tr class="header">

                            <td>1</td>
                            <td>2</td>
                            <td>3</td>
                            <td>4</td>
                            <td>5</td>
                            <td>6</td>
                            <td>7</td>
                            <td>8</td>
                            <td>9</td>
                            <td>10</td>
                            <td>11</td>
                            <td>12</td>
                        </tr>

                        <tr id="seg1">

                            <td>1</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg2">
                            <td>2</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg3">
                            <td>3</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg4">
                            <td>4</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg5">
                            <td>5</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg6">
                            <td>6</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg7">
                            <td>7</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg8">
                            <td>8</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg9">
                            <td>9</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg10">
                            <td>10</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg11">
                            <td>11</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg12">
                            <td>12</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>

                    </table>
                </div>
                <div class="nagivation-row">
                    <paper-button> << previous</paper-button>
                    <div>{{segment}}</div>
                    <paper-button>next >></paper-button>
                </div>
                <array-selector id="selector" items="{{combatants}}" selected="{{currentCombatants}}" multi></array-selector>
                <template id="segmentCombatants" is="dom-repeat" items="{{currentCombatants}}" sort="compareDexAndSpeed">
                    <div class="combatant-row">
                        <span>{{item.name}}</span>&nbsp;(SPD:&nbsp;<span>{{item.speed}}</span>,&nbsp;Dex:&nbsp;<span>{{item.dex}}</span>)
                    </div>
                </template>
            </div>
        </paper-material>
    </template>

    <script>


        SpeedChart = Polymer({
            is: 'speed-chart',
            properties: {
                combatants: {
                    type: Array, value: function () {
                        return [];
                    }, notify: true
                },
                currentsegment: {type: Number, readOnly: true, computed: 'formattedSegment()'},
                current_combatants: {type: Array, readOnly: true, computed: 'currentCombatants()', notify: true},
                segment: {type: Number, value: -1, observer: ''}

            },

            nextPhase: function () {
                var phase = (this.segment + 1) % 12;
                this.set('segment', phase);
                this.updateDisplay();

            },

            previousPhase: function () {
                var phase = this.segment - 1;
                if (phase < 0) {
                    phase = 11;
                }
                this.set('segment', phase);
                this.updateDisplay();
            },

            formattedSegment: function () {
                var seg = this.segment;
                if (seg == 0) {
                    seg = 12;
                }
                if (seg == -1){
                    seg = "Initial Action"
                }
                return seg;
            },

            updateDisplay: function () {
                for (var j = 0; j < this.combatants.length; j++) {
                    if (this.segment == -1) {
                        this.$.selector.select(this.combatants[j]);
                    }else {
                        this.$.selector.deselect(this.combatants[j]);
                    }
                }
                var segmentSpeeds = this._spdChart[this.segment];
                for (var i = 0; i < segmentSpeeds.length; i++) {
                    for(var j = 0; j < this.combatants.length; j++) {
                        if (this.combatants[j].speed == segmentSpeeds[i]) {
                            console.log(this.combatants[j]);
                            this.$.selector.select(this.combatants[j]);
                        }
                    }
                }

            },

            ready: function () {

                this._spdChart = {
                    0: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
                    1: [12],
                    2: [6, 7, 8, 9, 10, 11, 12],
                    3: [4, 5, 8, 9, 10, 11, 12],
                    4: [3, 6, 7, 9, 10, 11, 12],
                    5: [5, 8, 10, 11, 12],
                    6: [2, 4, 6, 7, 8, 9, 10, 11, 12],
                    7: [1, 7, 9, 11, 12],
                    8: [3, 5, 6, 8, 9, 10, 11, 12],
                    9: [4, 7, 8, 10, 11, 12],
                    10: [5, 6, 9, 10, 11, 12],
                    11: [7, 8, 9, 10, 11, 12]
                };

            },

            addCombatant: function (combatant) {
                combatant.display = true;
                this.push('combatants', combatant);
                this.updateDisplay();
            },

            removeCombatant: function (combatant) {
                var index = this.combatants.indexOf(combatant);
                this.splice('combatants', index, 1);
            },

            isPhase: function (combatant) {
                return combatant.display;
            },

            compareDexAndSpeed: function (c1, c2) {
                if (c1.dex > c2.dex) {
                    return -1
                }
                if (c1.dex < c2.dex) {
                    return 1
                }
                if (c1.speed > c2.speed) {
                    return -1
                }
                if (c1.speed < c2.speed) {
                    return 1
                }
                return 0;
            }
        });

    </script>

</dom-module>
