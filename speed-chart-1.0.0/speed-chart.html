<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<!--
An element that provides a speed chart for Hero System games with basic combat order management tools.

Example:

    <speed-chart id="spdChart">
    </speed-chart>

@demo
-->
<dom-module id="speed-chart">

    <style>
        :host {
        @apply(--layout-vertical);
        }

        .container {
            display: flex;
            flex-direction: column;
            padding: 5px;
        }



        .combatant-row {
            display: flex;
            flex-flow: row nowrap;
            justify-content: space-between;
        }

        .combatant-row div.name {
            flex-grow: 4;
        }

        td {
            margin: 1px;
            text-align: center;
        }

        .cell {
             padding: 2px;
        }

        .current {
            background-color: #f48fb1;
        }

        .header td {
            border: 1px solid;
        }

    </style>

    <template>
        <paper-material elevation="2">
            <div class="container">
                <div class="row">
                    <table>

                        <tr class="header">
                            <td rowspan="2">Segment</td>
                            <td colspan="12">Speed</td>
                        </tr>
                        <tr class="header">

                            <td>1</td>
                            <td>2</td>
                            <td>3</td>
                            <td>4</td>
                            <td>5</td>
                            <td>6</td>
                            <td>7</td>
                            <td>8</td>
                            <td>9</td>
                            <td>10</td>
                            <td>11</td>
                            <td>12</td>
                        </tr>

                        <tr id="seg1">

                            <td>1</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg2">
                            <td>2</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg3">
                            <td>3</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg4">
                            <td>4</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg5">
                            <td>5</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg6">
                            <td>6</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg7">
                            <td>7</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg8">
                            <td>8</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg9">
                            <td>9</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg10">
                            <td>10</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg11">
                            <td>11</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>
                        <tr id="seg12">
                            <td>12</td>
                            <td>&mdash;</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                            <td>x</td>
                        </tr>

                    </table>
                </div>
                <template is="dom-repeat" items="{{combatants}}" filter="isPhase"
                          observe="combatants.*.speed _segment">
                    <div class="combatant-row">
                        <div class="name cell">{{item.name}}</div>
                        <div class="cell">{{item.speed}}</div>
                        <div class="cell">{{item.dex}}</div>
                    </div>
                </template>
            </div>
        </paper-material>
    </template>

    <script>


        SpeedChart = Polymer({
            is: 'speed-chart',
            properties: {
                combatants: {
                    type: Array, value: function () {
                        return [];
                    }, notify: true
                },
                current_segment: {type: Number, readOnly: true, computed: 'currentSegment()'},
                current_combatants: {type: Array, readOnly: true, computed: 'currentCombatants()', notify: true},
                _segment: {type: Number, value: -1}

            },

            nextPhase: function () {
                var phase = (this._segment + 1) % 12;
                this.set('_segment', phase);
                for (var i = 0; i < 12; i++) {
                    if (this._segment === phase) {
                        Polymer.toggleClass('current', true, this.$$('seg' + i));
                    } else {
                        Polymer.toggleClass('current', false, this.$$('seg' + i));
                    }
                }

            },

            previousPhase: function () {
                var phase = this._segment - 1;
                if (phase < 0) {
                    phase = 11;
                }
                this.set('_segment', phase);
                for (var i = 0; i < 12; i++) {
                    if (this._segment === phase) {
                        Polymer.toggleClass('current', true, this.$$('seg' + i));
                    } else {
                        Polymer.toggleClass('current', false, this.$$('seg' + i));
                    }
                }
            },

            formattedSegment: function () {
                var seg = this._segment;
                if (seg == 0) {
                    seg = 12;
                }
                return seg;
            },

            ready: function () {

                this._spdChart = {
                    0: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
                    1: [12],
                    2: [6, 7, 8, 9, 10, 11, 12],
                    3: [4, 5, 8, 9, 10, 11, 12],
                    4: [3, 6, 7, 9, 10, 11, 12],
                    5: [5, 8, 10, 11, 12],
                    6: [2, 4, 6, 7, 8, 9, 10, 11, 12],
                    7: [1, 7, 9, 11, 12],
                    8: [3, 5, 6, 8, 9, 10, 11, 12],
                    9: [4, 7, 8, 10, 11, 12],
                    10: [5, 6, 9, 10, 11, 12],
                    11: [7, 8, 9, 10, 11, 12]
                };

//             this.set('combatants', [{name: "Baz", dex: 13, speed: 3}]);
//             this.set('_segment', 0);
//             this.set('_spdChart', {
//                 0: [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
//                 1: [12],
//                 2: [6, 7, 8, 9, 10, 11, 12],
//                 3: [4, 5, 8, 9, 10, 11, 12],
//                 4: [3, 6, 7, 9, 10, 11, 12],
//                 5: [5, 8, 10, 11, 12],
//                 6: [2, 4, 6, 7, 8, 9, 10, 11, 12],
//                 7: [1, 7, 9, 11, 12],
//                 8: [3, 5, 6, 8, 9, 10, 11, 12],
//                 9: [4, 7, 8, 10, 11, 12],
//                 10: [5, 6, 9, 10, 11, 12],
//                 11: [7, 8, 9, 10, 11, 12]
//             });

            },

            addCombatant: function (combatant) {
                this.push('combatants', combatant);
            },

            removeCombatant: function (combatant) {
                var index = this.combatants.indexOf(combatant);
                this.splice('combatants', index, 1);
            },

            isPhase: function (combatant) {
                if (this._segment === -1)
                    return true;
                var speeds = this._spdChart[this._segment];
                for (var i = 0; i < speeds.length; i++) {
                    if (speeds[i] === combatant.speed) {
                        return true;
                    }
                }
                return false;
            }
        });

    </script>

</dom-module>